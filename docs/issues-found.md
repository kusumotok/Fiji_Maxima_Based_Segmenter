# Maxima-Based Segmenter Suite - 発見された問題

## Issue 1: プラグインの格納位置について

**現状**: `Segmentation > [plugin_name_Folder > plugin]` という構造で、Segmentation下に3つのフォルダがある

**提案**:
- オプションA: Segmentation直下にプラグインを配置
- オプションB: Segmentation下に1つのフォルダを作り、その下に3つのプラグインを配置

**優先度**: 低

**対応方法**: `plugins.config` のメニューパスを変更

**ステータス**: ✅ 対応済み（Segmentation > Maxima Based Segmenter フォルダ下に3つのプラグインを配置）

---

## Issue 2: デフォルトのtoleranceが小さい

**現状**: 開いた途端にLogが出て少し重たくなる

**提案**: デフォルトのtoleranceを高めに設定（例: 10.0 → 2000.0）

**優先度**: 中

**対応方法**: `ThresholdModel` のデフォルト値を変更

**ステータス**: ✅ 対応済み（デフォルト値を2000.0に変更）

---

## Issue 3: Processエリアのプレビューのオーバーレイが見にくい

**現状**: プレビューの色が見にくい

**提案**: 色をつけたほうが良い

**優先度**: 中

**対応方法**: `AppearanceSettings` のデフォルト色を調整

**ステータス**: ✅ 対応済み（domainColorをグレー(0x808080)から緑(0x00FF00)に変更）

---

## Issue 4: 3D版の依存関係について

**現状**: IJPB-Pluginsをインストールする必要があるが、ドキュメントに記載されていない

**提案**: ドキュメントに依存関係を明記

**優先度**: 高

**対応方法**: README.md に依存関係セクションを追加

**ステータス**: ✅ 対応済み（README.mdに記載済み）

---

## Issue 5: 3D版のメモリ不足について ⚠️ 重大

**現状**: 512×512×9の16bit画像でOut of Memory Errorが発生

**エラー箇所**: `PreviewRenderer.buildSeedCentroids()` で巨大な配列を確保

**根本原因**: 
- MorphoLibJが生成するラベルIDが非連続（sparse）
- 例: 10個のシードでもラベルIDが1, 50, 120, 300, ..., 100万など
- `buildSeedCentroids()` が最大ラベルIDサイズの配列を確保
- `double[1000001]` × 3 = 約24MB × プレビュー更新回数

**対応内容**: 
- `MarkerResult3D.getSlice()` でラベルIDを1から連番に再マッピング
- これにより配列サイズが実際のシード数に応じた適切なサイズになる

**優先度**: 最高（クリティカル）

**ステータス**: ✅ 解決済み

---

## Issue 6: 3D版のSeedプレビュー

**現状**: まだ確認されていない（推測）

**提案**:
- エリア: 各スライスごとで表示
- Seedのクロス: 
  - 当該スライス: 通常表示
  - 他のスライス: 透明度を上げるか、色を変えて表示
  - これによりSeedの数がわかりやすくなる

**優先度**: 中

**対応方法**: `PreviewRenderer.renderMarkerFill3D()` を拡張して、全スライスのシード位置を表示

**ステータス**: ✅ 対応済み（全スライスのシードを表示：現在のスライスはフルカラー（赤）、他のスライスは半透明青色）

---

## Issue 7: Zスライス移動時のラグ

**現状**: Zスライスの移動に対してもデバウンス（遅延）が適用されている

**問題点**: 
- メモリにすでにあるデータを表示するだけなので、計算は不要
- Threshold変更やTolerance変更のような重い計算は発生しない
- デバウンスは不要

**提案**: Zスライス移動時はデバウンスなしで即座にプレビュー更新

**優先度**: 中

**対応方法**: `Segmenter3DFrame` のZ平面変更リスナーで、デバウンスをスキップ

**ステータス**: 未対応

---

## Issue 8: ROI作成の処理時間とプレビューのフリーズ (NEW)

**問題1**: Add ROIボタンでエラー `Invalid group: 1065353216`

**原因**: MorphoLibJが32bit float形式のラベル画像を返すため、`ip.get()` で取得した値が浮動小数点数として解釈されていた

**修正**: `ip.getPixelValue()` + `Math.round()` で正しく整数に変換

**ステータス**: ✅ 解決済み

---

**問題2**: ROI Boundariesプレビューで完全にフリーズ

**原因**: 
- `ip.get()` で取得した最大ラベル値が浮動小数点数として解釈され、巨大な値（1065353216）になっていた
- `for (int label = 1; label <= maxLabel; label++)` のループが10億回以上実行されてフリーズ

**修正**: 
- 最大ラベル値を探す代わりに、実際に存在するユニークなラベルのみを収集
- ユニークなラベルのみをループ処理

**ステータス**: ✅ 解決済み

**優先度**: 高（クリティカル）

---

## Issue 9: BGプレビューの必要性 (NEW)

**現状**: BGのプレビューが表示されている

**提案**: Domainのプレビューが見やすければBGプレビューは不要

**優先度**: 低（軽微な修正）

**対応方法**: BGプレビューをデフォルトでオフにする

**ステータス**: ✅ 対応済み（AppearanceSettingsでshowBg = falseに変更）

---

## Issue 10: FindMaxima時のFGエリア表示 (NEW)

**現状**: FindMaximaのときもFGエリア（赤いエリア）が表示されている

**問題点**: 
- 内部に存在する（操作不能な）FG Thresholdによって赤くエリアが表示されている
- FindMaximaの場合、Seedは必ず1点になるのでcrossのみ表示すれば良い

**提案**: FindMaxima使用時はFGエリアを非表示にし、Seed crossのみ表示

**優先度**: 中

**対応方法**: `PreviewRenderer.renderMarkerFill()` で、MarkerSourceがFIND_MAXIMAの場合はseedMaskを表示しない

**ステータス**: ✅ 対応済み（PreviewRendererにMarkerSourceパラメータを追加し、FIND_MAXIMA時はseedMaskを非表示に）

---

## Issue 11: パネルを閉じてもプレビューが残る (NEW)

**現状**: プラグインのパネルを閉じても、画像上のプレビューオーバーレイが残ったまま

**問題点**: プレビューが残ると画像が見にくくなる

**提案**: パネルを閉じた時にオーバーレイを自動的にクリア

**優先度**: 中

**対応方法**: 各フレームの`windowClosing`イベントで`clearOverlay()`を呼び出す

**ステータス**: ✅ 対応済み（SimpleSegmenterFrame、DualThresholdFrame、Segmenter3DFrameすべてに実装）

---

## 対応優先順位

### 完了
1. ✅ **Issue 5** (最高): メモリ不足 - 解決済み
2. ✅ **Issue 4** (高): 依存関係ドキュメント - 対応済み
3. ✅ **Issue 8** (高): ROI作成とプレビューのフリーズ - 解決済み
4. ✅ **Issue 7** (中): Zスライス移動時のラグ - 解決済み
5. ✅ **Issue 2** (中): デフォルトtolerance - 対応済み
6. ✅ **Issue 3** (中): プレビュー色 - 対応済み
7. ✅ **Issue 6** (中): 3D Seedプレビュー拡張 - 対応済み
8. ✅ **Issue 10** (中): FindMaxima時のFGエリア表示 - 対応済み
9. ✅ **Issue 11** (中): パネルを閉じてもプレビューが残る - 対応済み
10. ✅ **Issue 9** (低): BGプレビューの必要性 - 対応済み
11. ✅ **Issue 1** (低): メニュー構造 - 対応済み

### 未対応（優先順位順）
なし - すべてのissueが対応済み

---

## すべてのissueが対応完了しました！

以下の11個のissueがすべて解決されました：

1. ✅ メニュー構造の整理
2. ✅ デフォルトtoleranceの調整（2000.0に変更）
3. ✅ プレビュー色の改善（緑色に変更）
4. ✅ 依存関係のドキュメント化
5. ✅ 3D版のメモリ不足問題の解決
6. ✅ 3D Seedプレビューの拡張（全スライス表示）
7. ✅ Zスライス移動時のラグ解消
8. ✅ ROI作成とプレビューのフリーズ解決
9. ✅ BGプレビューをデフォルトでオフ
10. ✅ FindMaxima時のFGエリア非表示
11. ✅ パネルを閉じた時のプレビュークリア
